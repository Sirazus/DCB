

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oris - Chat</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  
  <style>
    body { font-family: 'Inter', sans-serif; }
    .chat-bubble-user { background-color: #e0f2fe; border-radius: 20px 20px 5px 20px; }
    .chat-bubble-bot { background-color: #ffffff; border-radius: 20px 20px 20px 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .starter-question-btn { transition: all 0.2s ease-in-out; }
    .starter-question-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

  <header class="bg-white shadow flex items-center justify-between px-4 sm:px-6 py-3">
    <div class="flex items-center gap-3">
      <i class="fas fa-tooth text-2xl text-blue-500"></i>
      <div>
        <span class="font-bold text-lg text-gray-800">Oris Chat</span>
        <p id="user-email" class="text-xs text-gray-500">Cargando...</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
<a id="dashboard-btn" href="#" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:shadow-xl transition">
        ðŸ“Š Dashboard
      </a>
            <a href="profile.html" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-full transition-all duration-300 shadow-sm hover:shadow-md">
        <i class="fas fa-user fa-fw"></i>
        <span class="hidden sm:inline ml-2">Perfil</span>
      </a>
      <button id="logout-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-full transition-all duration-300 shadow-sm hover:shadow-md">
        <i class="fas fa-sign-out-alt fa-fw"></i>
        <span class="hidden sm:inline ml-2">Salir</span>
      </button> </div>
  </header>

  <main id="chat-box" class="flex-1 overflow-y-auto px-4 py-6 space-y-4">
    <div class="flex items-start gap-3">
      <div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center shadow-md"><i class="fas fa-tooth"></i></div>
      <div class="chat-bubble-bot p-4 max-w-md">
        <p class="font-semibold text-gray-700 mb-1">Oris</p>
        <p class="text-gray-600">Â¡Hola! Soy tu asistente dental. Â¿En quÃ© puedo ayudarte hoy?</p>
      </div>
    </div>
    <div id="starter-questions-container" class="pt-2 pb-2">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-3xl mx-auto">
        </div>
    </div>
  </main>
  
  <footer class="bg-white shadow-t px-4 py-3">
    <div class="flex items-center gap-2">
      <input id="user-input" type="text" placeholder="Escribe tu mensaje..." class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled/>
      <button id="send-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-full" disabled><i class="fas fa-paper-plane"></i></button>
    </div>
  </footer>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js'; 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ConfiguraciÃ³n de Firebase
    

    // InicializaciÃ³n de servicios de Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Selectores de Elementos del DOM
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const dashboardLink = document.getElementById("dashboard-link");
    const userEmailSpan = document.getElementById("user-email");
    const starterQuestionsContainer = document.getElementById("starter-questions-container");

    // Variables de estado
    let currentUser = null;
    const starterQuestions = [
        "Â¿CuÃ¡ndo estÃ¡ indicado extraer un diente que ha sido tratado endodÃ³nticamente?",
        "Â¿QuÃ© abordajes clÃ­nicos existen para tratar la resorciÃ³n cervical invasiva?",
        "Â¿CuÃ¡ndo estÃ¡ indicado el uso de CBCT en endodoncia?",
        "Â¿QuÃ© riesgos y efectos adversos presenta el blanqueamiento en clÃ­nica?"
    ];

    // --- Funciones auxiliares ---

    function escapeHtml(s) {
      return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    function formatMessageText(text) {
      const escapedText = escapeHtml(text);
      const boldedText = escapedText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
      return boldedText;
    }

    function displayStarterQuestions() {
        const grid = starterQuestionsContainer.querySelector('.grid');
        if (!grid) return;
        starterQuestions.forEach(question => {
            const button = document.createElement('button');
            button.className = "starter-question-btn bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 text-sm text-left p-3 rounded-lg shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-blue-400";
            button.innerHTML = `<i class="far fa-comment-dots mr-2 text-blue-500"></i> ${escapeHtml(question)}`;
            button.addEventListener('click', () => {
                userInput.value = question;
                sendMessage();
            });
            grid.appendChild(button);
        });
    }

    function appendMessage(sender, text) {
      const wrapper = document.createElement("div");
      wrapper.className = "flex items-start gap-3 " + (sender === "TÃº" ? "justify-end" : "");
      if (sender === "TÃº") {
        wrapper.innerHTML = `<div class="chat-bubble-user p-4 max-w-md"><p class="font-semibold text-blue-800 mb-1">TÃº</p><p class="text-gray-700 whitespace-pre-line">${formatMessageText(text)}</p></div><div class="flex-shrink-0 w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center shadow-md"><i class="fas fa-user"></i></div>`;
      } else {
        wrapper.innerHTML = `<div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center shadow-md"><i class="fas fa-tooth"></i></div><div class="chat-bubble-bot p-4 max-w-md"><p class="font-semibold text-gray-700 mb-1">Oris</p><p class="text-gray-600 whitespace-pre-line">${formatMessageText(text)}</p></div>`;
      }
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function stripThinkBlocks(text) {
      return text.replace(/<think>[\s\S]*?<\/think>/g, "").trim();
    }

    async function saveConversation(userMessage, botRaw, botVisible) {
      await addDoc(collection(db, "conversations"), {
        uid: currentUser ? currentUser.uid : null,
        email: currentUser ? currentUser.email : null,
        user: userMessage,
        bot_raw: botRaw,
        bot: botVisible,
        timestamp: serverTimestamp()
      });
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      if (starterQuestionsContainer.style.display !== 'none') {
        starterQuestionsContainer.style.display = 'none';
      }

      appendMessage("TÃº", text);
      userInput.value = "";

      const loader = document.createElement("div");
      loader.className = "flex items-start gap-3";
      loader.innerHTML = `<div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center shadow-md"><i class="fas fa-tooth"></i></div><div class="chat-bubble-bot p-4"><div class="flex space-x-1"><span class="h-2 w-2 bg-blue-300 rounded-full animate-bounce [animation-delay:-0.3s]"></span><span class="h-2 w-2 bg-blue-300 rounded-full animate-bounce [animation-delay:-0.15s]"></span><span class="h-2 w-2 bg-blue-300 rounded-full animate-bounce"></span></div></div>`;
      chatBox.appendChild(loader);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const response = await fetch("https://sdentalch-medicalassisstantbot.hf.space/v1/chat/completions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "MedicalAssisstantBot/v1",
            messages: [{ role: "user", content: text }],
            stream: false,
            conversation_id: currentUser.uid
          })
        });
        const data = await response.json();
        chatBox.removeChild(loader);
        const botRaw = data?.choices?.[0]?.message?.content || "Lo siento, hubo un error.";
        const botVisible = stripThinkBlocks(botRaw) || "Lo siento, la respuesta llegÃ³ vacÃ­a.";
        appendMessage("Oris", botVisible);
        saveConversation(text, botRaw, botVisible);
      } catch (error) {
        console.error(error);
        chatBox.removeChild(loader);
        appendMessage("Oris", "Error al conectar con la API.");
      }
    }

    // --- LÃ³gica Principal y Event Listeners ---

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      userInput.disabled = false;
      sendBtn.disabled = false;
      userEmailSpan.textContent = user.email;
      
      displayStarterQuestions();

      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (userDoc.exists() && userDoc.data().role === "admin") {
        dashboardLink.href = "dashboard_admin.html";
      } else {
        dashboardLink.href = "user-dashboard.html";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>